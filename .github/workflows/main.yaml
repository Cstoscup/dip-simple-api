name: Deploy
on:
  push:
    branches: [ "main" ]

jobs:
  # build:
  #   name: Build Docker Image
  #   runs-on: ubuntu-latest
  #   steps:
  #       - name: Checkout
  #         uses: actions/checkout@v2
  #       - name: Configure AWS Credentials
  #         uses: aws-actions/configure-aws-credentials@v4
  #         with:
  #           aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
  #           aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  #           aws-region: ${{secrets.AWS_REGION}}
  #       - name: Log into AWS ECR
  #         id: login-aws-ecr
  #         uses: aws-actions/amazon-ecr-login@v2
  #       - name: Build and Push Image to ECR
  #         env:
  #           ECR_REGISTRY: ${{ steps.login-aws-ecr.outputs.registry }}
  #           ECR_REPOSITORY: ${{secrets.AWS_ECR_REPO}}
  #           IMAGE_TAG: latest
  #         run: |
  #           docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
  #           docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    # needs: build
    steps:
        - name: Configure AWS Credentials
          uses: aws-actions/configure-aws-credentials@v4
          with:
            aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
            aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            aws-region: ${{secrets.AWS_REGION}}
        - name: Log into AWS ECR
          id: login-aws-ecr
          uses: aws-actions/amazon-ecr-login@v2
        - name: Pull and Run ECR Image on EC2 Instance
          env:
            ECR_IMAGE_TO_DEPLOY: ${{ steps.login-aws-ecr.outputs.registry }}/${{secrets.AWS_ECR_REPO}}:latest
            INSTANCE_ID_1: ${{secrets.INSTANCE_ID_1}}
            INSTANCE_ID_2: ${{secrets.INSTANCE_ID_2}}
            CONTAINER_NAME: "api"
          run: |
            command_id=$(aws ssm send-command \
              --targets Key=InstanceIds,Values=${{env.INSTANCE_ID_1}},${{env.INSTANCE_ID_2}} \
              --document-name "AWS-RunShellScript" \
              --comment "Executing Docker operations" \
              --parameters commands='[
                "set -e",
                "aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 339712797927.dkr.ecr.us-east-1.amazonaws.com",
                "docker stop ${{ env.CONTAINER_NAME }} || true",
                "docker pull ${{ env.ECR_IMAGE_TO_DEPLOY }}",
                "docker run --rm -d -p 3000:3000 --name ${{ env.CONTAINER_NAME }} ${{ env.ECR_IMAGE_TO_DEPLOY }}"
              ]' --query 'Command.CommandId' --output text)

            echo "command_id=$command_id" >> $GITHUB_ENV
